let gui;
let button;
let thinking;
let backgroundColor = 220;
let textArea = {
  x: 20,
  y: 20,
  width: 350,
  height: 100,
  placeholder: "æƒ³è¦æ”¾æ¾å¿ƒæƒ…",
  isTitle: false,
};

let content = "";
let gift = "";
let describe = "";
let agent = new P5GPT();

// æ¥æ”¶åˆ°GPTå®Œæ•´çš„æ¶ˆæ¯æ—¶ä¼šè°ƒç”¨çš„å‡½æ•°
function whenComplete(text) {
  content = text.replace(/\n/g, ""); // åˆ å»æ¢è¡Œï¼Œä»¥å…æ ¼å¼é”™è¯¯
  parsedData = JSON.parse(content);
  gift = parsedData["ç¤¼ç‰©åç§°"];
  describe = parsedData["ç¤¼ç‰©æè¿°"];
  thinking = false;

}

function setup() {
  createCanvas(400, 800); // åˆ›å»ºç®¡ç†GUIçš„ç³»ç»Ÿ
  gui = createGui();
  joker = new Sprite();
  joker.image = 'ğŸ¤¡';
  joker.x = 200;
  joker.y = 250;
  button = createButton("è®¸æ„¿", 20, 130);
  textSize(20);
  agent.setSystemPrompt("æ ¹æ®ç”¨æˆ·è¾“å…¥çš„å¿ƒæ„¿è¾“å‡ºç¤¼ç‰©åå­—å’Œç¤¼ç‰©æè¿°ï¼Œæ³¨æ„è¯·ç”¨jsonå›ç­”é—®é¢˜ï¼Œä¸¤ä¸ªkeyæ˜¯ç¤¼ç‰©åç§°å’Œç¤¼ç‰©æè¿°");
  textArea.text = textArea.placeholder;
  // åŠ è½½èƒŒæ™¯å›¾ç‰‡
  backgroundImage = loadImage('data/1.jpg');
}

function draw() {
  background(backgroundImage); // ä½¿ç”¨åŠ è½½çš„å›¾ç‰‡ä½œä¸ºèƒŒæ™¯
  textSize(16);
  noStroke();
  joker.visible = true;
  fill("white");
  textArea = createTextArea(textArea);
  fill("black");
  textWrap(CHAR);
  text("ç¤¼ç‰©åç§°", 20, 390);
  text("ç¤¼ç‰©æè¿°", 20, 540);
  noFill();
  stroke(0);
  rect(20, 400, 350, 100);
  rect(20, 550, 350, 100);
  
  // åœ¨å¯¹åº”çš„æ–‡æœ¬æ¡†é‡Œæ˜¾ç¤ºæ€è€ƒè¿‡ç¨‹å’Œç­”æ¡ˆ
  noStroke();
  fill("black");
  text(gift, 25, 420, 340, 80);
  text(describe, 25, 570, 340, 80);
  
  // æ¯å¸§é‡ç»˜GUI
  drawGui();

  if (button.isPressed) {
    content = "";
    gift = "";
    describe = "";
    thinking = true;
    agent.clearAllMessage();
    agent.send(textArea.text, false);
    agent.onComplete = whenComplete;
  }
  if (thinking) {
    joker.rotation++;
  }
  else{
    joker.rotation = 0;
  }
  if (gift == "è¯·é‡æ–°è®¸æ„¿") {
    joker.visible = false;
  }
}
